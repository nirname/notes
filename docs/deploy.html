<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>deploy</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        background-color: #ffffff;
        color: #a0a0a0;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #a0a0a0;  padding-left: 4px; }
    div.sourceCode
      { color: #1f1c1b; background-color: #ffffff; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #1f1c1b; } /* Normal */
    code span.al { color: #bf0303; background-color: #f7e6e6; font-weight: bold; } /* Alert */
    code span.an { color: #ca60ca; } /* Annotation */
    code span.at { color: #0057ae; } /* Attribute */
    code span.bn { color: #b08000; } /* BaseN */
    code span.bu { color: #644a9b; font-weight: bold; } /* BuiltIn */
    code span.cf { color: #1f1c1b; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #924c9d; } /* Char */
    code span.cn { color: #aa5500; } /* Constant */
    code span.co { color: #898887; } /* Comment */
    code span.cv { color: #0095ff; } /* CommentVar */
    code span.do { color: #607880; } /* Documentation */
    code span.dt { color: #0057ae; } /* DataType */
    code span.dv { color: #b08000; } /* DecVal */
    code span.er { color: #bf0303; text-decoration: underline; } /* Error */
    code span.ex { color: #0095ff; font-weight: bold; } /* Extension */
    code span.fl { color: #b08000; } /* Float */
    code span.fu { color: #644a9b; } /* Function */
    code span.im { color: #ff5500; } /* Import */
    code span.in { color: #b08000; } /* Information */
    code span.kw { color: #1f1c1b; font-weight: bold; } /* Keyword */
    code span.op { color: #1f1c1b; } /* Operator */
    code span.ot { color: #006e28; } /* Other */
    code span.pp { color: #006e28; } /* Preprocessor */
    code span.re { color: #0057ae; background-color: #e0e9f8; } /* RegionMarker */
    code span.sc { color: #3daee9; } /* SpecialChar */
    code span.ss { color: #ff5500; } /* SpecialString */
    code span.st { color: #bf0303; } /* String */
    code span.va { color: #0057ae; } /* Variable */
    code span.vs { color: #bf0303; } /* VerbatimString */
    code span.wa { color: #bf0303; } /* Warning */
  </style>
  <link rel="stylesheet" href="github-markdown.css" />
</head>
<body>
<h1 id="deployment-wip">Deployment (WIP)</h1>
<p>Это ознакомительная статья, рассчитанная на</p>
<h2 id="что-это-такое">Что это такое?</h2>
<blockquote>
<p><strong>deployment</strong> (или <strong>deploy</strong>) - это процесс доставки новой версии сайта на сервер</p>
</blockquote>
<p>Сайт - это программа. Даже если сайт состоит только из HTML, этот HTML можно рассматривать как инструкцию для браузера (что и как отображать).</p>
<p>При локальной разработке, сайт находится на Вашем компьютере. Чтобы сделать сайт доступным для пользователей по сети, нужно сделать так, чтобы компьютер, на котором находится этот сайт, также был доступен по сети, и мог обмениваться с пользователями данными.</p>
<p>Для этого существует 2 варианта:</p>
<ol type="1">
<li><p>Сделать ваш собственный компьютер доступным по сети. Годится для прототипирования и обсуждения сайта с коллегами. Ваши изменения в коде будут видны сразу же (и любые ошибки - тоже). Как только вы отключились от сети или выключили компьютер, сайт перестанет быть доступным.</p></li>
<li><p>Переложить сайт на другой, выделенный компьютер (сервер). Он постоянно включён и доступен по сети, за исключением периодов обслуживания. Разработка ведётся по прежнему на вашем ПК, следовательно код, однажды попав на сервер не изменяется до следующего обновления.</p></li>
</ol>
<p>Процесс доставки новой версии сайта на сервер и назвается <strong>deployment</strong> (или <strong>deploy</strong>).</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="87pt" height="131pt"
 viewBox="0.00 0.00 87.00 131.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 127)">
<title>%3</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-127 83,-127 83,4 -4,4"/>
<!-- code -->
<g id="node1" class="node">
<title>code</title>
<polygon fill="none" stroke="black" points="58,-123 4,-123 4,-87 58,-87 58,-123"/>
<text text-anchor="middle" x="31" y="-101.3" font-family="Times,serif" font-size="14.00">code</text>
</g>
<!-- server -->
<g id="node2" class="node">
<title>server</title>
<polygon fill="none" stroke="black" points="62,-36 0,-36 0,0 62,0 62,-36"/>
<text text-anchor="middle" x="31" y="-14.3" font-family="Times,serif" font-size="14.00">server</text>
</g>
<!-- code&#45;&gt;server -->
<g id="edge1" class="edge">
<title>code&#45;&gt;server</title>
<path fill="none" stroke="black" d="M31,-86.8C31,-75.16 31,-59.55 31,-46.24"/>
<polygon fill="black" stroke="black" points="34.5,-46.18 31,-36.18 27.5,-46.18 34.5,-46.18"/>
<text text-anchor="middle" x="55" y="-57.8" font-family="Times,serif" font-size="14.00">deploy</text>
</g>
</g>
</svg>

<p>В этот процесс входит не только обновление кода, но и как правило сжатие и обфускация скриптов, сжатие картинок, запуск / перезапуск сопутствующих программ или компонент, обновление структуры базы данных, обновление самих данных и многое другое.</p>
<p>Часто сервер может быть не один</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="272pt" height="116pt"
 viewBox="0.00 0.00 272.00 116.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 112)">
<title>%3</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-112 268,-112 268,4 -4,4"/>
<!-- code -->
<g id="node1" class="node">
<title>code</title>
<polygon fill="none" stroke="black" points="159,-108 105,-108 105,-72 159,-72 159,-108"/>
<text text-anchor="middle" x="132" y="-86.3" font-family="Times,serif" font-size="14.00">code</text>
</g>
<!-- server1 -->
<g id="node2" class="node">
<title>server1</title>
<polygon fill="none" stroke="black" points="76,-36 0,-36 0,0 76,0 76,-36"/>
<text text-anchor="middle" x="38" y="-14.3" font-family="Times,serif" font-size="14.00">server 1</text>
</g>
<!-- code&#45;&gt;server1 -->
<g id="edge1" class="edge">
<title>code&#45;&gt;server1</title>
<path fill="none" stroke="black" d="M108.76,-71.7C96.81,-62.8 82.08,-51.82 69.15,-42.2"/>
<polygon fill="black" stroke="black" points="71.08,-39.27 60.97,-36.1 66.9,-44.88 71.08,-39.27"/>
</g>
<!-- server2 -->
<g id="node3" class="node">
<title>server2</title>
<polygon fill="none" stroke="black" points="170,-36 94,-36 94,0 170,0 170,-36"/>
<text text-anchor="middle" x="132" y="-14.3" font-family="Times,serif" font-size="14.00">server 2</text>
</g>
<!-- code&#45;&gt;server2 -->
<g id="edge2" class="edge">
<title>code&#45;&gt;server2</title>
<path fill="none" stroke="black" d="M132,-71.7C132,-63.98 132,-54.71 132,-46.11"/>
<polygon fill="black" stroke="black" points="135.5,-46.1 132,-36.1 128.5,-46.1 135.5,-46.1"/>
</g>
<!-- server3 -->
<g id="node4" class="node">
<title>server3</title>
<polygon fill="none" stroke="black" points="264,-36 188,-36 188,0 264,0 264,-36"/>
<text text-anchor="middle" x="226" y="-14.3" font-family="Times,serif" font-size="14.00">server 3</text>
</g>
<!-- code&#45;&gt;server3 -->
<g id="edge3" class="edge">
<title>code&#45;&gt;server3</title>
<path fill="none" stroke="black" d="M155.24,-71.7C167.19,-62.8 181.92,-51.82 194.85,-42.2"/>
<polygon fill="black" stroke="black" points="197.1,-44.88 203.03,-36.1 192.92,-39.27 197.1,-44.88"/>
</g>
</g>
</svg>

<p>Ввиду того, что это однообразная рутинная задача, deploy автоматизируют, которую, к тому же, нужно выполнить сразу на множестве серверов, его автоматизируют.</p>
<h2 id="самый-простой-деплой">Самый простой деплой</h2>
<p>Один из самых простых деплоев - это просто зайти на сервер, где работает ваш сайт, скачать исходный код и перезапустить ваш веб-сервер (node, nginx, puma, apache и т.д.)</p>
<p>Самое простое - это скопировать ваш исходный код на сервер (ip адрес здесь - просто пример):</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="fu">scp</span> -r project user@127.0.10.10:/home/user/project</span></code></pre></div>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="225pt" height="44pt"
 viewBox="0.00 0.00 225.00 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<title>%3</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-40 221,-40 221,4 -4,4"/>
<!-- computer -->
<g id="node1" class="node">
<title>computer</title>
<polygon fill="none" stroke="black" points="85,-36 0,-36 0,0 85,0 85,-36"/>
<text text-anchor="middle" x="42.5" y="-14.3" font-family="Times,serif" font-size="14.00">computer</text>
</g>
<!-- server -->
<g id="node2" class="node">
<title>server</title>
<polygon fill="none" stroke="black" points="217,-36 155,-36 155,0 217,0 217,-36"/>
<text text-anchor="middle" x="186" y="-14.3" font-family="Times,serif" font-size="14.00">server</text>
</g>
<!-- computer&#45;&gt;server -->
<g id="edge1" class="edge">
<title>computer&#45;&gt;server</title>
<path fill="none" stroke="black" d="M85.19,-18C103.95,-18 126.01,-18 144.61,-18"/>
<polygon fill="black" stroke="black" points="144.83,-21.5 154.83,-18 144.83,-14.5 144.83,-21.5"/>
<text text-anchor="middle" x="120" y="-21.8" font-family="Times,serif" font-size="14.00">code</text>
</g>
</g>
</svg>

<p>Скорее всего вы будете хранить ваш исходных код где-то в системе версионирования (как правило это git, иногда svn или другие варианты), поэтому обновление кода на сервере будет выглядеть иначе:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="fu">ssh</span> root@127.0.10.10</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="bu">cd</span> ~/project/</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span class="fu">git</span> pull</span></code></pre></div>
<p>Перезагрузка сервера делается разными способами.</p>
<p>Как один из возможных вариантов:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="fu">ps</span> xa <span class="kw">|</span> <span class="fu">grep</span> node </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="bu">kill</span> -2 PID</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a><span class="ex">node</span> server.js <span class="kw">&amp;</span></span></code></pre></div>
<p>Наверняка вы хотите, чтобы ваш процесс работал в background, т.к. как только вы отключиесь от ssh ваш процесс должен продолжать работу. Вариантов, опять же масса, такие как <code>nohup</code>, <code>systemd</code> и многие другие.</p>
<h2 id="минимальная-автоматизация">Минимальная автоматизация</h2>
<p>Чтобы не перезагружать сервер руками, а просто делать <code>git pull</code> настраивают разнообразные утилиты (watcher-ы, listener-ы), которые следят за изменениями кода на вашем сервере и перезагружают ваш веб-сервер, как только вы сделали pull. Такие вещи, чаще всего, работают в development режиме, поскольку код на сервере не будет изменияться так же часто, как локально. Кроме того, иногда бывает необходимо перезагрузить ваш сервер, обновить его конфигурацию и т.д.</p>
<p>Можно написать bash скрипт, который заходит на сервер, делает там pull и перезапускает веб-сервер, и для этого процесса уже написана масса утилит, таких как Capistrano, Ansible, Chef, Puppit, Jenkins. Это не значит, что они предназначены только для deploy, часто они используются совместно и для разных задач.</p>
<hr />
<p>WIP</p>
</body>
</html>
