# Deployment (WIP)

Это ознакомительная статья, рассчитанная на

## Что это такое?

> **deployment** (или **deploy**) - это процесс доставки новой версии сайта на сервер

Сайт - это программа. Даже если сайт состоит только из HTML, этот HTML можно рассматривать как инструкцию для браузера (что и как отображать).

При локальной разработке, сайт находится на Вашем компьютере. Чтобы сделать сайт доступным для пользователей по сети, нужно сделать так, чтобы компьютер, на котором находится этот сайт, также был доступен по сети, и мог обмениваться с пользователями данными.

Для этого существует 2 варианта:

1. Сделать ваш собственный компьютер доступным по сети. Годится для прототипирования и обсуждения сайта с коллегами. Ваши изменения в коде будут видны сразу же (и любые ошибки - тоже). Как только вы отключились от сети или выключили компьютер, сайт перестанет быть доступным.

2. Переложить сайт на другой, выделенный компьютер (сервер). Он постоянно включён и доступен по сети, за исключением периодов обслуживания. Разработка ведётся по прежнему на вашем ПК, следовательно код, однажды попав на сервер не изменяется до следующего обновления.

Процесс доставки новой версии сайта на сервер и назвается **deployment** (или **deploy**).

```dot
digraph {
    node[shape=rect];
    code -> server [label="deploy"];
}
```

В этот процесс входит не только обновление кода, но и как правило сжатие и обфускация скриптов, сжатие картинок, запуск / перезапуск сопутствующих программ или компонент, обновление структуры базы данных, обновление самих данных и многое другое.

Часто сервер может быть не один

```dot
digraph {
    node[shape=rect];
    code -> {
        server1 [label="server 1"];
        server2 [label="server 2"];
        server3 [label="server 3"];
    }
}
```

Ввиду того, что это однообразная рутинная задача, deploy автоматизируют, которую, к тому же, нужно выполнить сразу на множестве серверов, его автоматизируют.

## Самый простой деплой

Один из самых простых деплоев - это просто зайти на сервер, где работает ваш сайт, скачать исходный код и перезапустить ваш веб-сервер (node, nginx, puma, apache и т.д.)

Самое простое - это скопировать ваш исходный код на сервер (ip адрес здесь - просто пример):
```bash
scp -r project user@127.0.10.10:/home/user/project
```

```dot
digraph {
    rankdir=LR;
    node[shape=rect];
    computer -> server [label=code];
}
```

Скорее всего вы будете хранить ваш исходных код где-то в системе версионирования (как правило это git, иногда svn или другие варианты), поэтому обновление кода на сервере будет выглядеть иначе:

```bash
ssh root@127.0.10.10
cd ~/project/
git pull
```

Перезагрузка сервера делается разными способами.

Как один из возможных вариантов:

```bash
ps xa | grep node 
kill -2 PID
node server.js &
```

Наверняка вы хотите, чтобы ваш процесс работал в background, т.к. как только вы отключиесь от ssh ваш процесс должен продолжать работу. Вариантов, опять же масса, такие как `nohup`, `systemd` и многие другие.

## Минимальная автоматизация

Чтобы не перезагружать сервер руками, а просто делать `git pull` настраивают разнообразные утилиты (watcher-ы, listener-ы), которые следят за изменениями кода на вашем сервере и перезагружают ваш веб-сервер, как только вы сделали pull. Такие вещи, чаще всего, работают в development режиме, поскольку код на сервере не будет изменияться так же часто, как локально. Кроме того, иногда бывает необходимо перезагрузить ваш сервер, обновить его конфигурацию и т.д.

Можно написать bash скрипт, который заходит на сервер, делает там pull и перезапускает веб-сервер, и для этого процесса уже написана масса утилит, таких как Capistrano, Ansible, Chef, Puppit, Jenkins. Это не значит, что они предназначены только для deploy, часто они используются совместно и для разных задач.

---

WIP