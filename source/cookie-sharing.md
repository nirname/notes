# Cookie sharing

Кука устанавливается для определённого домена.

Одни и те же cookie можно использовать для домена и его поддоменов.

Выдержка из [ответа на stackoverflow](https://stackoverflow.com/a/23086139/4175647)

> Согласно стандарту, In RFC 2109 домен без лидирущий точки означает, что кука не может быть использована на поддоменах.
> и только домет с лидирущей точкой позволяет использовать одни и теже куки на поддоменах
> Согласно более новой спецификации RFC 6265, лидирующая точка игнорируется, и куки для домена без точки может быть использована на поддоменах.

Однако, невзирая на новую спецификацию, кука без точки по разным причинам может игнорироваться поддоменами.

Допустим, вы хотите поменять домен для куки на существующем проекте Rails
и разрешить его использование на поддоменах.
Для этого нужно указать `domain: :all` явно:

```ruby
cookies.signed[:user_id] = { value: user.id, domain: :all }
```

Не забудьте указать домен при удалении куки:

```ruby
cookies.delete(:user_id, domain: :all)
```

Дальше &mdash; сложности. В браузере будет 2 куки, одна для домена с точкой, другая для домена без.
Поэтому удалять их надо обе.
Например, если они отвечают за аутентификацию, пользователь не сможет выйти с сайта.
Однако rails не удалит куку с одним и тем же именем дважды, поэтому конструкция вида:

```ruby
cookies.delete(:user_id, domain: :all)
cookies.delete(:user_id)
```

не поможет.

Если пользователей много, то объяснять им, что "вам надо почистить куки" бесполезно.
Что делать? Либо дописывать Rails, либо использовать ~~грязный трюк~~ двойной redirect:

```ruby
def logout
  cookies.delete(:user_id, domain: :all)
  redirect_to logout_domain_path
end

def logout_domain
  cookies.delete(:user_id, domain: nil)
  redirect_to root_path
end
```